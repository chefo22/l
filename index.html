<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=0.8, user-scalable=no">
  <title>üóíÔ∏è</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e50c7;
      --bg-light: #f1f5f9;
      --card-bg: #ffffff;
      --text: #1e293b;
      --border-color: #e2e8f0;
      --white: #ffffff;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --error: #dc2626;
      --success: #16a34a;
      --warning: #d97706;
      --info: #0284c7;
    }
    
    body.dark-mode {
      --bg-light: #131313;
      --card-bg: #333436;
      --text: #f8fafc;
      --border-color: #555555;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    body {
      background: var(--bg-light);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      transition: all 0.3s;
    }
    
    .main-container {
      max-width: 1400px;
      margin: 1rem auto;
      padding: 0 1rem;
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .app-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .header-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .search-filters {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-sm);
    }
    
    .search-box {
      position: relative;
      margin-bottom: 0.8rem;
    }
    
    .search-box input {
      width: 100%;
      padding: 0.6rem 1rem 0.6rem 2.2rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      background-color: var(--card-bg);
      color: var(--text);
      box-sizing: border-box;
    }
    
    .search-box::before {
      content: "üîç";
      position: absolute;
      left: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text);
      font-size: 0.9rem;
    }
    
    .filter-buttons {
      display: flex;
      gap: 0.6rem;
      margin-top: 0.8rem;
    }
    
    .filter-button {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .filter-button:hover {
      border-color: var(--primary);
    }
    
    .filter-button--active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .filter-button--favorites, .filter-button--clear {
      flex: 0 0 auto;
      width: 36px;
      min-width: 36px;
      padding: 0.5rem 0;
    }
    
    .emoji-filters {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .emoji-filter-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .emoji-filter-btn:hover {
      border-color: var(--primary);
    }
    
    .emoji-filter-btn--active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .channels-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }
    
    .channel-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 1rem;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
      position: relative;
      user-select: none;
      touch-action: none;
    }
    
    .channel-card.draggable {
      cursor: grab;
    }
    
    .channel-card.draggable:active {
      cursor: grabbing;
    }
    
    .channel-card.dragging {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 100;
      opacity: 0.9;
    }
    
    .channel-card.dropzone {
      border: 2px dashed var(--primary);
    }
    
    .channel-card:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    .channel-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }
    
    .channel-card--favorite {
      border: 2px solid var(--primary);
    }
    
    .channel-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .channel-name {
      font-weight: 600;
      flex-grow: 1;
      padding: 0 0.5rem;
      text-align: center;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .channel-number {
      color: var(--primary);
      font-weight: 600;
      font-size: 0.75rem;
    }
    
    .channel-time {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .channel-time--live::before, .channel-name--live::before {
      content: "";
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #dc2626;
      animation: pulse 1.5s infinite;
    }
    
    .channel-event {
      font-size: 0.8rem;
      margin-top: 0.5rem;
    }
    
    .channel-sport {
      font-size: 0.7rem;
      color: var(--primary);
      margin-top: 0.2rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .channel-language {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 0.7rem;
      background: rgba(37, 99, 235, 0.1);
      padding: 0.2rem 0.4rem;
      border-radius: var(--radius-sm);
    }
    
    .channel-rating {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      font-size: 0.7rem;
      color: var(--warning);
    }
    
    .player-container {
      background: black;
      border-radius: var(--radius-md);
      overflow: hidden;
      width: 100%;
      height: calc(57vw + 40px);
      max-height: 85vh;
      display: none;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .player-container--active {
      display: block;
      animation: tvOn 0.5s ease;
    }
    
    .player-container--minimized {
      height: 200px;
      width: 300px;
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    
    #videoFrame {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .player-controls {
      display: none;
      gap: 10px;
      justify-content: center;
      padding: 10px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      position: relative;
      margin-bottom: 10px;
    }
    
    .player-controls--active {
      display: flex;
    }
    
    .control-btn {
      background: var(--primary);
      border: none;
      color: white;
      cursor: pointer;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .control-btn:hover {
      background: var(--primary-dark);
    }
    
    .control-btn--active {
      background: var(--primary-dark);
    }
    
    .channel-info {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      font-weight: 600;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .channel-number-display {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .channel-group {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 0;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-sm);
    }
    
    .channel-group__header {
      padding: 0.8rem 1rem;
      background: rgba(var(--primary-rgb), 0.1);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .channel-group__title {
      font-weight: 600;
      color: var(--text);
    }
    
    .channel-group__sport {
      font-size: 0.8rem;
      color: var(--primary);
      margin-top: 0.2rem;
    }
    
    .channel-group__content {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 0.8rem;
      padding: 0.8rem;
    }
    
    .channel-group__content--collapsed {
      display: none;
    }
    
    .no-results {
      text-align: center;
      padding: 2rem;
      color: var(--text);
      opacity: 0.7;
      font-size: 1.1rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal--active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: modalFadeIn 0.3s ease;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .modal-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text);
    }
    
    .settings-section {
      margin-bottom: 1.5rem;
    }
    
    .settings-section-title {
      font-weight: 600;
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-option:last-child {
      border-bottom: none;
    }
    
    .settings-option-label {
      flex: 1;
    }
    
    .settings-option-description {
      font-size: 0.8rem;
      color: var(--text);
      opacity: 0.7;
      margin-top: 0.3rem;
    }
    
    .color-picker {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .color-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .color-option--active {
      border-color: var(--text);
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-input {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      color: var(--text);
    }
    
    .form-select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      color: var(--text);
    }
    
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }
    
    .btn {
      padding: 0.6rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      border-color: var(--primary);
    }
    
    .btn-danger {
      background: var(--error);
      color: white;
      border: none;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .import-export-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1rem;
    }
    
    .import-export-tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .import-export-tab--active {
      border-bottom-color: var(--primary);
      color: var(--primary);
      font-weight: 500;
    }
    
    .import-export-content {
      display: none;
    }
    
    .import-export-content--active {
      display: block;
    }
    
    .json-textarea {
      width: 100%;
      min-height: 200px;
      padding: 0.8rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      color: var(--text);
      font-family: monospace;
      margin-bottom: 1rem;
    }
    
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.8rem 1rem;
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }
    
    .notification--success {
      border-left: 4px solid var(--success);
    }
    
    .notification--error {
      border-left: 4px solid var(--error);
    }
    
    .notification--active {
      transform: translateY(0);
      opacity: 1;
    }
    
    .scroll-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      z-index: 999;
    }
    
    .scroll-to-top--visible {
      opacity: 1;
      visibility: visible;
    }
    
    .star {
      cursor: pointer;
      font-size: 1.5rem;
      color: #ccc;
    }
    
    .star.active {
      color: var(--warning);
    }
    
    .confirm-dialog {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .confirm-dialog p {
      margin-bottom: 1.5rem;
    }
    
    .confirm-dialog-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    
    .delete-btn {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--error);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
      border: none;
    }
    
    .edit-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
      border: none;
    }
    
    .channel-card:hover .delete-btn,
    .channel-card:hover .edit-btn {
      opacity: 1;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    
    @keyframes tvOn {
      0% { opacity: 0; transform: scale(0.9); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    @keyframes modalFadeIn {
      0% { opacity: 0; transform: translateY(-20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    
    @media (max-width: 768px) {
      .channels-grid {
        grid-template-columns: 1fr;
      }
      
      .filter-buttons {
        flex-wrap: nowrap;
      }
      
      .channel-group__content {
        grid-template-columns: 1fr;
      }
      
      .channel-info, .channel-number-display {
        position: static;
        transform: none;
        font-size: 0.75rem;
        max-width: 30%;
      }
      
      .channel-info {
        text-align: left;
        flex: 1;
      }
      
      .channel-number-display {
        text-align: right;
        margin-left: auto;
      }
      
      .player-container {
        height: calc(100vw * 0.56);
      }
    }
    
    @media (min-width: 768px) {
      .channels-grid {
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      }
      
      .channel-name {
        font-size: 1rem;
      }
      
      .channel-event {
        font-size: 0.9rem;
      }
      
      .channel-sport {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Header -->
    <div class="app-header">
      <h1 class="app-title">üóíÔ∏è</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" id="addLinkBtn">+ A√±adir Enlace</button>
        <button class="btn btn-secondary" id="settingsBtn">‚öôÔ∏è Ajustes</button>
        <button class="btn btn-secondary" id="toggleThemeBtn">üåì Tema</button>
        <button class="btn btn-secondary" id="toggleDragBtn">‚áÖ Reordenar</button>
        <button class="btn btn-danger" id="clearAllBtn">üóëÔ∏è Borrar Todo</button>
      </div>
    </div>
    
    <!-- Player Section -->
    <div class="player-section" id="playerSection">
      <div class="player-container" id="playerContainer">
        <iframe id="videoFrame" frameborder="0" allowfullscreen></iframe>
      </div>
      <div class="player-controls" id="playerControls">
        <span class="channel-info" id="channelInfo"></span>
        <button class="control-btn" id="prevChannelBtn" title="Canal anterior">‚óÑ</button>
        <button class="control-btn" id="nextChannelBtn" title="Canal siguiente">‚ñ∫</button>
        <button class="control-btn" id="toggleStickyBtn" title="Fijar reproductor">‚õä</button>
        <button class="control-btn" id="favoriteBtn" title="Guardar favorito">‚òÖ</button>
        <button class="control-btn" id="closePlayerBtn" title="Cerrar">√ó</button>
        <span class="channel-number-display" id="channelNumberDisplay"></span>
      </div>
    </div>
    
    <!-- Search & Filters -->
    <div class="search-filters">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Buscar canales, n√∫mero (ej: #123) o hora (ej: 15:30)">
      </div>
      <div class="filter-buttons">
        <button class="filter-button filter-button--favorites" id="filterFavorites">‚òÖ</button>
        <button class="filter-button filter-button--active" id="filterWeb">V√≠a Web</button>
        <button class="filter-button" id="filterAcestream">Acestream</button>
        <button class="filter-button" id="filterSources">Fuentes</button>
        <button class="filter-button filter-button--clear" id="clearFilters">x</button>
      </div>
      <div class="emoji-filters" id="emojiFilters">
        <button class="emoji-filter-btn" data-filter="F1" title="F1">üèéÔ∏è</button>
        <button class="emoji-filter-btn" data-filter="F√∫tbol" title="F√∫tbol">‚öΩ</button>
        <button class="emoji-filter-btn" data-filter="Baloncesto" title="Baloncesto">üèÄ</button>
        <button class="emoji-filter-btn" data-filter="Motorsport" title="Motorsport">üèÅ</button>
        <button class="emoji-filter-btn" data-filter="Espa√±a" title="Espa√±a">üá™üá∏</button>
        <button class="emoji-filter-btn" data-filter="UK" title="UK">üá¨üáß</button>
      </div>
    </div>
    
    <!-- Channels Content -->
    <div id="channelsContent">
      <!-- Content will be dynamically generated -->
    </div>
    
    <!-- No Results -->
    <div class="no-results" id="noResults" style="display: none;">
      No se encontraron resultados. Prueba con otros filtros.
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Configuraci√≥n</h2>
          <button class="modal-close" id="closeSettingsModal">&times;</button>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-section-title">‚öôÔ∏è Preferencias</h3>
          <div class="settings-option">
            <div class="settings-option-label">
              Modo oscuro
              <div class="settings-option-description">Cambia entre tema claro y oscuro</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="darkModeToggle">
              <span class="slider round"></span>
            </label>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              Color principal
              <div class="settings-option-description">Personaliza el color de la interfaz</div>
            </div>
            <div class="color-picker">
              <div class="color-option color-option--active" style="background: #2563eb;" data-color="#2563eb"></div>
              <div class="color-option" style="background: #dc2626;" data-color="#dc2626"></div>
              <div class="color-option" style="background: #16a34a;" data-color="#16a34a"></div>
              <div class="color-option" style="background: #d97706;" data-color="#d97706"></div>
              <div class="color-option" style="background: #7c3aed;" data-color="#7c3aed"></div>
              <div class="color-option" style="background: #db2777;" data-color="#db2777"></div>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-section-title">üì∫ Reproductor</h3>
          <div class="settings-option">
            <div class="settings-option-label">
              Modo de apertura
              <div class="settings-option-description">C√≥mo se abren los enlaces</div>
            </div>
            <select class="form-select" id="playerModeSelect">
              <option value="newTab">Nueva pesta√±a (predeterminado)</option>
              <option value="inline">Reproductor interno (solo web)</option>
            </select>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              Recordar tama√±o del reproductor
              <div class="settings-option-description">Guarda la √∫ltima altura del reproductor</div>
            </div>
            <label class="switch">
              <input type="checkbox" id="rememberPlayerSize" checked>
              <span class="slider round"></span>
            </label>
          </div>
        </div>
        
        <div class="settings-section">
          <h3 class="settings-section-title">üìÅ Gesti√≥n de Datos</h3>
          <div class="import-export-tabs">
            <div class="import-export-tab import-export-tab--active" data-tab="export">Exportar</div>
            <div class="import-export-tab" data-tab="import">Importar</div>
          </div>
          
          <div class="import-export-content import-export-content--active" id="exportTab">
            <textarea class="json-textarea" id="exportLinksData" readonly></textarea>
            <button class="btn btn-primary" id="copyExportLinksBtn">Copiar JSON</button>
          </div>
          
          <div class="import-export-content" id="importTab">
            <textarea class="json-textarea" id="importLinksData" placeholder="Pega aqu√≠ el JSON de exportaci√≥n"></textarea>
            <div class="form-actions">
              <button class="btn btn-secondary" id="cancelImportBtn">Cancelar</button>
              <button class="btn btn-primary" id="importLinksBtn">Importar Datos</button>
            </div>
          </div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" id="cancelSettingsBtn">Cancelar</button>
          <button class="btn btn-primary" id="saveSettingsBtn">Guardar</button>
        </div>
      </div>
    </div>
    
    <!-- Add Link Modal -->
    <div class="modal" id="addLinkModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">‚ûï A√±adir Nuevo Enlace</h2>
          <button class="modal-close" id="closeAddLinkModal">&times;</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">URL del enlace</label>
          <input type="text" class="form-input" id="linkUrl" placeholder="https://ejemplo.com/stream">
        </div>
        
        <div class="form-group">
          <label class="form-label">T√≠tulo</label>
          <input type="text" class="form-input" id="linkTitle" placeholder="Nombre del canal o evento">
        </div>
        
        <div class="form-group">
          <label class="form-label">Web de origen (opcional)</label>
          <input type="text" class="form-input" id="webName" placeholder="Ej: Movistar, DAZN...">
        </div>
        
        <div class="form-group">
          <label class="form-label">Deporte</label>
          <select class="form-select" id="linkSport">
            <option value="F√∫tbol">F√∫tbol ‚öΩ</option>
            <option value="Baloncesto">Baloncesto üèÄ</option>
            <option value="F1">F√≥rmula 1 üèéÔ∏è</option>
            <option value="Motorsport">Motorsport üèÅ</option>
            <option value="Tenis">Tenis üéæ</option>
            <option value="Golf">Golf ‚õ≥</option>
            <option value="Otros">Otros</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Color de borde (opcional)</label>
          <input type="color" class="form-input" id="linkColor" value="#2563eb">
        </div>
        
        <div class="form-group">
          <label class="form-label">Idioma</label>
          <select class="form-select" id="linkLanguage">
            <option value="ES">Espa√±ol üá™üá∏</option>
            <option value="EN">Ingl√©s üá¨üáß</option>
            <option value="OT">Otro</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tipo de enlace</label>
          <select class="form-select" id="linkType">
            <option value="web">V√≠a Web</option>
            <option value="acestream">Acestream</option>
            <option value="source">Fuente</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Mostrar icono</label>
          <label class="switch">
            <input type="checkbox" id="mostrarIcono">
            <span class="slider round"></span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">Mostrar m√∫ltiple</label>
          <label class="switch">
            <input type="checkbox" id="mostrarMulti">
            <span class="slider round"></span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">Puntuaci√≥n (1-5)</label>
          <div class="rating-stars" id="ratingStars">
            <span class="star" data-value="1">‚òÖ</span>
            <span class="star" data-value="2">‚òÖ</span>
            <span class="star" data-value="3">‚òÖ</span>
            <span class="star" data-value="4">‚òÖ</span>
            <span class="star" data-value="5">‚òÖ</span>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Etiquetas (separadas por comas)</label>
          <input type="text" class="form-input" id="etiquetas" placeholder="Ej: HD, 4K, Deportes">
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" id="cancelAddLinkBtn">Cancelar</button>
          <button class="btn btn-primary" id="saveLinkBtn">Guardar Enlace</button>
        </div>
      </div>
    </div>
    
    <!-- Edit Link Modal -->
    <div class="modal" id="editLinkModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">‚úèÔ∏è Editar Enlace</h2>
          <button class="modal-close" id="closeEditLinkModal">&times;</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">URL del enlace</label>
          <input type="text" class="form-input" id="editLinkUrl" placeholder="https://ejemplo.com/stream">
        </div>
        
        <div class="form-group">
          <label class="form-label">T√≠tulo</label>
          <input type="text" class="form-input" id="editLinkTitle" placeholder="Nombre del canal o evento">
        </div>
        
        <div class="form-group">
          <label class="form-label">Web de origen (opcional)</label>
          <input type="text" class="form-input" id="editWebName" placeholder="Ej: Movistar, DAZN...">
        </div>
        
        <div class="form-group">
          <label class="form-label">Deporte</label>
          <select class="form-select" id="editLinkSport">
            <option value="F√∫tbol">F√∫tbol ‚öΩ</option>
            <option value="Baloncesto">Baloncesto üèÄ</option>
            <option value="F1">F√≥rmula 1 üèéÔ∏è</option>
            <option value="Motorsport">Motorsport üèÅ</option>
            <option value="Tenis">Tenis üéæ</option>
            <option value="Golf">Golf ‚õ≥</option>
            <option value="Otros">Otros</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Color de borde (opcional)</label>
          <input type="color" class="form-input" id="editLinkColor" value="#2563eb">
        </div>
        
        <div class="form-group">
          <label class="form-label">Idioma</label>
          <select class="form-select" id="editLinkLanguage">
            <option value="ES">Espa√±ol üá™üá∏</option>
            <option value="EN">Ingl√©s üá¨üáß</option>
            <option value="OT">Otro</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tipo de enlace</label>
          <select class="form-select" id="editLinkType">
            <option value="web">V√≠a Web</option>
            <option value="acestream">Acestream</option>
            <option value="source">Fuente</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Mostrar icono</label>
          <label class="switch">
            <input type="checkbox" id="editMostrarIcono">
            <span class="slider round"></span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">Mostrar m√∫ltiple</label>
          <label class="switch">
            <input type="checkbox" id="editMostrarMulti">
            <span class="slider round"></span>
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">Puntuaci√≥n (1-5)</label>
          <div class="rating-stars" id="editRatingStars">
            <span class="star" data-value="1">‚òÖ</span>
            <span class="star" data-value="2">‚òÖ</span>
            <span class="star" data-value="3">‚òÖ</span>
            <span class="star" data-value="4">‚òÖ</span>
            <span class="star" data-value="5">‚òÖ</span>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Etiquetas (separadas por comas)</label>
          <input type="text" class="form-input" id="editEtiquetas" placeholder="Ej: HD, 4K, Deportes">
        </div>
        
        <div class="form-group">
          <label class="form-label">Favorito</label>
          <label class="switch">
            <input type="checkbox" id="editFavorito">
            <span class="slider round"></span>
          </label>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-secondary" id="cancelEditLinkBtn">Cancelar</button>
          <button class="btn btn-primary" id="saveEditLinkBtn">Guardar Cambios</button>
        </div>
      </div>
    </div>
    
    <!-- Confirm Clear All Modal -->
    <div class="modal" id="confirmClearModal">
      <div class="confirm-dialog">
        <h3>¬øEst√°s seguro?</h3>
        <p>Esta acci√≥n borrar√° todos los enlaces y la configuraci√≥n. Esta acci√≥n no se puede deshacer.</p>
        <div class="confirm-dialog-buttons">
          <button class="btn btn-secondary" id="cancelClearBtn">Cancelar</button>
          <button class="btn btn-danger" id="confirmClearBtn">Borrar Todo</button>
        </div>
      </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div class="modal" id="confirmDeleteModal">
      <div class="confirm-dialog">
        <h3>¬øBorrar este enlace?</h3>
        <p>Esta acci√≥n no se puede deshacer.</p>
        <div class="confirm-dialog-buttons">
          <button class="btn btn-secondary" id="cancelDeleteBtn">Cancelar</button>
          <button class="btn btn-danger" id="confirmDeleteBtn">Borrar</button>
        </div>
      </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification"></div>
    
    <!-- Scroll to top -->
    <div class="scroll-to-top" id="scrollToTop">‚Üë</div>
  </div>

  <script>
    // App State
    const state = {
      links: [],
      settings: {
        darkMode: false,
        primaryColor: '#2563eb',
        playerMode: 'newTab',
        rememberPlayerSize: true,
        playerHeight: null,
        expandedGroups: {},
        dragEnabled: false
      },
      filters: {
        searchText: '',
        type: 'web',
        sport: null,
        favoritesOnly: false
      },
      currentPlayer: {
        channelId: null,
        isSticky: false,
        isMinimized: false
      },
      dragState: {
        isDragging: false,
        draggedItem: null,
        draggedIndex: null,
        targetIndex: null
      },
      deleteState: {
        linkId: null
      },
      editState: {
        linkId: null
      },
      clearButtonState: {
        clickCount: 0,
        lastClickTime: 0
      }
    };

    // DOM Elements
    const elements = {
      channelsContent: document.getElementById('channelsContent'),
      noResults: document.getElementById('noResults'),
      playerContainer: document.getElementById('playerContainer'),
      playerControls: document.getElementById('playerControls'),
      videoFrame: document.getElementById('videoFrame'),
      channelInfo: document.getElementById('channelInfo'),
      channelNumberDisplay: document.getElementById('channelNumberDisplay'),
      prevChannelBtn: document.getElementById('prevChannelBtn'),
      nextChannelBtn: document.getElementById('nextChannelBtn'),
      toggleStickyBtn: document.getElementById('toggleStickyBtn'),
      favoriteBtn: document.getElementById('favoriteBtn'),
      closePlayerBtn: document.getElementById('closePlayerBtn'),
      searchInput: document.getElementById('searchInput'),
      filterFavorites: document.getElementById('filterFavorites'),
      filterWeb: document.getElementById('filterWeb'),
      filterAcestream: document.getElementById('filterAcestream'),
      filterSources: document.getElementById('filterSources'),
      clearFilters: document.getElementById('clearFilters'),
      emojiFilters: document.getElementById('emojiFilters'),
      settingsModal: document.getElementById('settingsModal'),
      addLinkModal: document.getElementById('addLinkModal'),
      editLinkModal: document.getElementById('editLinkModal'),
      confirmClearModal: document.getElementById('confirmClearModal'),
      confirmDeleteModal: document.getElementById('confirmDeleteModal'),
      cancelClearBtn: document.getElementById('cancelClearBtn'),
      confirmClearBtn: document.getElementById('confirmClearBtn'),
      cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
      confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
      clearAllBtn: document.getElementById('clearAllBtn'),
      darkModeToggle: document.getElementById('darkModeToggle'),
      playerModeSelect: document.getElementById('playerModeSelect'),
      rememberPlayerSize: document.getElementById('rememberPlayerSize'),
      exportLinksData: document.getElementById('exportLinksData'),
      importLinksData: document.getElementById('importLinksData'),
      copyExportLinksBtn: document.getElementById('copyExportLinksBtn'),
      importLinksBtn: document.getElementById('importLinksBtn'),
      cancelImportBtn: document.getElementById('cancelImportBtn'),
      saveSettingsBtn: document.getElementById('saveSettingsBtn'),
      closeSettingsModal: document.getElementById('closeSettingsModal'),
      cancelSettingsBtn: document.getElementById('cancelSettingsBtn'),
      linkUrl: document.getElementById('linkUrl'),
      linkTitle: document.getElementById('linkTitle'),
      webName: document.getElementById('webName'),
      linkSport: document.getElementById('linkSport'),
      linkLanguage: document.getElementById('linkLanguage'),
      linkType: document.getElementById('linkType'),
      linkColor: document.getElementById('linkColor'),
      mostrarIcono: document.getElementById('mostrarIcono'),
      mostrarMulti: document.getElementById('mostrarMulti'),
      etiquetas: document.getElementById('etiquetas'),
      ratingStars: document.getElementById('ratingStars'),
      saveLinkBtn: document.getElementById('saveLinkBtn'),
      cancelAddLinkBtn: document.getElementById('cancelAddLinkBtn'),
      closeAddLinkModal: document.getElementById('closeAddLinkModal'),
      editLinkUrl: document.getElementById('editLinkUrl'),
      editLinkTitle: document.getElementById('editLinkTitle'),
      editWebName: document.getElementById('editWebName'),
      editLinkSport: document.getElementById('editLinkSport'),
      editLinkLanguage: document.getElementById('editLinkLanguage'),
      editLinkType: document.getElementById('editLinkType'),
      editLinkColor: document.getElementById('editLinkColor'),
      editMostrarIcono: document.getElementById('editMostrarIcono'),
      editMostrarMulti: document.getElementById('editMostrarMulti'),
      editEtiquetas: document.getElementById('editEtiquetas'),
      editFavorito: document.getElementById('editFavorito'),
      editRatingStars: document.getElementById('editRatingStars'),
      saveEditLinkBtn: document.getElementById('saveEditLinkBtn'),
      cancelEditLinkBtn: document.getElementById('cancelEditLinkBtn'),
      closeEditLinkModal: document.getElementById('closeEditLinkModal'),
      addLinkBtn: document.getElementById('addLinkBtn'),
      settingsBtn: document.getElementById('settingsBtn'),
      toggleThemeBtn: document.getElementById('toggleThemeBtn'),
      toggleDragBtn: document.getElementById('toggleDragBtn'),
      importExportTabs: document.querySelectorAll('.import-export-tab'),
      importExportContents: document.querySelectorAll('.import-export-content'),
      notification: document.getElementById('notification'),
      scrollToTop: document.getElementById('scrollToTop')
    };

    // Initialize the app
    function init() {
      loadSettings();
      renderChannels();
      setupEventListeners();
      checkScrollPosition();
      updateDragButton();
    }

    // Load settings from localStorage
    function loadSettings() {
      const savedSettings = localStorage.getItem('daddyLiveHDSettings');
      if (savedSettings) {
        Object.assign(state.settings, JSON.parse(savedSettings));
      }
      
      const savedLinks = localStorage.getItem('daddyLiveHDLinks');
      if (savedLinks) {
        state.links = JSON.parse(savedLinks);
      }
      
      if (state.settings.darkMode) {
        document.body.classList.add('dark-mode');
      }
      
      if (state.settings.playerHeight && state.settings.rememberPlayerSize) {
        elements.playerContainer.style.height = `${state.settings.playerHeight}px`;
      }
      
      elements.darkModeToggle.checked = state.settings.darkMode;
      elements.playerModeSelect.value = state.settings.playerMode;
      elements.rememberPlayerSize.checked = state.settings.rememberPlayerSize;
      
      if (state.settings.primaryColor) {
        updatePrimaryColor(state.settings.primaryColor);
      }
    }

    // Update primary color and its darker shade
    function updatePrimaryColor(color) {
      document.documentElement.style.setProperty('--primary', color);
      const darkerColor = shadeColor(color, -20);
      document.documentElement.style.setProperty('--primary-dark', darkerColor);
      
      const rgb = hexToRgb(color);
      if (rgb) {
        document.documentElement.style.setProperty('--primary-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
      }
      
      document.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('color-option--active');
        if (opt.dataset.color === color) {
          opt.classList.add('color-option--active');
        }
      });
    }

    // Convert hex color to RGB
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    // Save settings to localStorage
    function saveSettings() {
      localStorage.setItem('daddyLiveHDSettings', JSON.stringify(state.settings));
      localStorage.setItem('daddyLiveHDLinks', JSON.stringify(state.links));
    }

    // Clear all data
    function clearAllData() {
      state.links = [];
      state.settings = {
        darkMode: false,
        primaryColor: '#2563eb',
        playerMode: 'newTab',
        rememberPlayerSize: true,
        playerHeight: null,
        expandedGroups: {},
        dragEnabled: false
      };
      
      localStorage.removeItem('daddyLiveHDSettings');
      localStorage.removeItem('daddyLiveHDLinks');
      
      document.body.classList.remove('dark-mode');
      elements.darkModeToggle.checked = false;
      elements.playerModeSelect.value = 'newTab';
      elements.rememberPlayerSize.checked = true;
      updatePrimaryColor('#2563eb');
      
      state.filters = {
        searchText: '',
        type: 'web',
        sport: null,
        favoritesOnly: false
      };
      
      elements.searchInput.value = '';
      updateTypeFilterButtons();
      updateEmojiFilterButtons();
      elements.filterFavorites.classList.remove('filter-button--active');
      
      closePlayer();
      renderChannels();
      updateDragButton();
      
      showNotification('Todos los datos han sido borrados');
    }

    // Delete a single link
    function deleteLink(linkId) {
      state.links = state.links.filter(link => link.id !== linkId);
      saveSettings();
      renderChannels();
      showNotification('Enlace eliminado');
    }

    // Render channels based on current filters
    function renderChannels() {
      const filteredLinks = state.links.filter(link => {
        if (state.filters.searchText) {
          const searchLower = state.filters.searchText.toLowerCase();
          const matchesTitle = link.title.toLowerCase().includes(searchLower);
          const matchesWebName = link.webName?.toLowerCase().includes(searchLower);
          
          if (!matchesTitle && !matchesWebName) {
            return false;
          }
        }
        
        if (state.filters.type && link.type !== state.filters.type) {
          return false;
        }
        
        if (state.filters.sport && link.deporte !== state.filters.sport) {
          return false;
        }
        
        if (state.filters.favoritesOnly && !link.favorito) {
          return false;
        }
        
        return true;
      });
      
      const linksByTitle = {};
      filteredLinks.forEach(link => {
        if (!linksByTitle[link.title]) {
          linksByTitle[link.title] = [];
        }
        linksByTitle[link.title].push(link);
      });
      
      let html = '';
      
      if (Object.keys(linksByTitle).length === 0) {
        elements.noResults.style.display = 'block';
        elements.channelsContent.innerHTML = '';
        return;
      }
      
      elements.noResults.style.display = 'none';
      
      for (const [title, links] of Object.entries(linksByTitle)) {
        const groupId = `group-${title.replace(/\s+/g, '-').toLowerCase()}`;
        const isExpanded = state.settings.expandedGroups[groupId] !== false;
        
        html += `
          <div class="channel-group" id="${groupId}">
            <div class="channel-group__header">
              <div class="channel-group__title">${title}</div>
            </div>
            <div class="channel-group__content ${isExpanded ? '' : 'channel-group__content--collapsed'}">
              ${links.map(link => renderLinkCard(link)).join('')}
            </div>
          </div>
        `;
      }
      
      elements.channelsContent.innerHTML = html;
      
      document.querySelectorAll('.channel-group__header').forEach(header => {
        header.addEventListener('click', function() {
          const groupId = this.parentElement.id;
          const content = this.nextElementSibling;
          
          content.classList.toggle('channel-group__content--collapsed');
          
          state.settings.expandedGroups[groupId] = !content.classList.contains('channel-group__content--collapsed');
          saveSettings();
        });
      });
      
      updateDragHandles();
    }

    // Render a single link card
    function renderLinkCard(link) {
      return `
        <div class="channel-card ${link.favorito ? 'channel-card--favorite' : ''} ${state.settings.dragEnabled ? 'draggable' : ''}" 
             data-id="${link.id}" 
             draggable="${state.settings.dragEnabled}"
             style="${link.color ? `border-color: ${link.color}` : ''}">
          <button class="delete-btn" data-id="${link.id}" title="Borrar enlace">√ó</button>
          ${state.settings.dragEnabled ? `<button class="edit-btn" data-id="${link.id}" title="Editar enlace">‚úèÔ∏è</button>` : ''}
          ${link.idioma ? `<span class="channel-language">${link.idioma}</span>` : ''}
          <div class="channel-header">
            <div class="channel-name">${link.webName || link.title}</div>
          </div>
          <div class="channel-sport">${link.deporte} ${getSportEmoji(link.deporte)}</div>
          ${link.puntuacion ? `<div class="channel-rating">${'‚òÖ'.repeat(link.puntuacion)}${'‚òÜ'.repeat(5 - link.puntuacion)}</div>` : ''}
          <div class="channel-type" style="position: absolute; bottom: 5px; left: 5px; font-size: 0.7rem; color: #666;">
            ${getTypeDisplay(link.type)}
          </div>
        </div>
      `;
    }

    // Update drag handles on all cards
    function updateDragHandles() {
      document.querySelectorAll('.channel-card').forEach(card => {
        if (state.settings.dragEnabled) {
          card.classList.add('draggable');
          card.setAttribute('draggable', 'true');
          
          // Add edit button if not already present
          if (!card.querySelector('.edit-btn')) {
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.setAttribute('data-id', card.dataset.id);
            editBtn.setAttribute('title', 'Editar enlace');
            editBtn.innerHTML = '‚úèÔ∏è';
            card.appendChild(editBtn);
          }
        } else {
          card.classList.remove('draggable');
          card.setAttribute('draggable', 'false');
          
          // Remove edit button if present
          const editBtn = card.querySelector('.edit-btn');
          if (editBtn) {
            editBtn.remove();
          }
        }
      });
    }

    // Update drag button state
    function updateDragButton() {
      if (state.settings.dragEnabled) {
        elements.toggleDragBtn.classList.add('filter-button--active');
        elements.toggleDragBtn.textContent = '‚úì Reordenar';
      } else {
        elements.toggleDragBtn.classList.remove('filter-button--active');
        elements.toggleDragBtn.textContent = '‚áÖ Reordenar';
      }
    }

    // Toggle drag mode
    function toggleDragMode() {
      state.settings.dragEnabled = !state.settings.dragEnabled;
      saveSettings();
      updateDragHandles();
      updateDragButton();
      showNotification(state.settings.dragEnabled ? 'Modo reordenar activado' : 'Modo reordenar desactivado');
    }

    // Get display text for type
    function getTypeDisplay(type) {
      const types = {
        'web': 'V√≠a Web',
        'acestream': 'Acestream',
        'source': 'Fuente'
      };
      return types[type] || type;
    }

    // Get emoji for sport
    function getSportEmoji(sport) {
      const emojis = {
        'F√∫tbol': '‚öΩ',
        'Baloncesto': 'üèÄ',
        'F1': 'üèéÔ∏è',
        'Motorsport': 'üèÅ',
        'Tenis': 'üéæ',
        'Golf': '‚õ≥',
        'TV Shows': 'üì∫'
      };
      return emojis[sport] || '';
    }

    // Open link in player
    function openLink(linkId) {
      const link = state.links.find(l => l.id === linkId);
      if (!link) return;
      
      state.currentPlayer.channelId = linkId;
      
      elements.channelInfo.textContent = link.title;
      elements.favoriteBtn.classList.toggle('control-btn--active', link.favorito);
      
      elements.videoFrame.srcdoc = `
        <!DOCTYPE html>
        <html>
        <head>
          <style>
            body { 
              background: black; 
              color: white; 
              display: flex; 
              justify-content: center; 
              align-items: center; 
              height: 100%; 
              margin: 0; 
              font-family: Arial, sans-serif;
            }
          </style>
        </head>
        <body>
          <div style="text-align: center;">
            <h2>${link.title}</h2>
            <p>${link.webName || ''}</p>
            <p>En la aplicaci√≥n real, esto mostrar√≠a el stream de ${link.link}</p>
          </div>
        </body>
        </html>
      `;
      
      elements.playerContainer.classList.add('player-container--active');
      elements.playerControls.classList.add('player-controls--active');
      elements.playerSection.scrollIntoView({ behavior: 'smooth' });
      
      if (state.settings.rememberPlayerSize) {
        state.settings.playerHeight = elements.playerContainer.offsetHeight;
        saveSettings();
      }
    }

    // Close player
    function closePlayer() {
      elements.playerContainer.classList.remove('player-container--active');
      elements.playerControls.classList.remove('player-controls--active');
      state.currentPlayer.channelId = null;
      
      if (state.currentPlayer.isMinimized) {
        toggleMinimizePlayer();
      }
    }

    // Toggle player sticky/minimized state
    function toggleMinimizePlayer() {
      state.currentPlayer.isMinimized = !state.currentPlayer.isMinimized;
      
      if (state.currentPlayer.isMinimized) {
        elements.playerContainer.classList.add('player-container--minimized');
        elements.toggleStickyBtn.classList.add('control-btn--active');
      } else {
        elements.playerContainer.classList.remove('player-container--minimized');
        elements.toggleStickyBtn.classList.remove('control-btn--active');
      }
    }

    // Toggle favorite status for current link
    function toggleFavorite() {
      if (!state.currentPlayer.channelId) return;
      
      const link = state.links.find(l => l.id === state.currentPlayer.channelId);
      if (link) {
        link.favorito = !link.favorito;
        elements.favoriteBtn.classList.toggle('control-btn--active', link.favorito);
        
        const linkCard = document.querySelector(`.channel-card[data-id="${link.id}"]`);
        if (linkCard) {
          linkCard.classList.toggle('channel-card--favorite', link.favorito);
        }
        
        showNotification(link.favorito ? 'A√±adido a favoritos' : 'Eliminado de favoritos');
        saveSettings();
      }
    }

    // Navigate to next/previous link
    function navigateLink(direction) {
      if (!state.currentPlayer.channelId) return;
      
      const currentIndex = state.links.findIndex(l => l.id === state.currentPlayer.channelId);
      if (currentIndex === -1) return;
      
      let newIndex;
      if (direction === 'next') {
        newIndex = (currentIndex + 1) % state.links.length;
      } else {
        newIndex = (currentIndex - 1 + state.links.length) % state.links.length;
      }
      
      openLink(state.links[newIndex].id);
    }

    // Show notification
    function showNotification(message, type = 'success') {
      elements.notification.textContent = message;
      elements.notification.className = `notification notification--${type}`;
      elements.notification.classList.add('notification--active');
      
      setTimeout(() => {
        elements.notification.classList.remove('notification--active');
      }, 3000);
    }

    // Check scroll position for scroll-to-top button
    function checkScrollPosition() {
      if (window.scrollY > 300) {
        elements.scrollToTop.classList.add('scroll-to-top--visible');
      } else {
        elements.scrollToTop.classList.remove('scroll-to-top--visible');
      }
    }

    // Drag and drop functions
    function handleDragStart(e) {
      if (!state.settings.dragEnabled) return;
      
      if (e.target.classList.contains('channel-card')) {
        state.dragState.isDragging = true;
        state.dragState.draggedItem = e.target;
        state.dragState.draggedIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
        
        e.target.classList.add('dragging');
        e.dataTransfer.setData('text/plain', e.target.dataset.id);
        e.dataTransfer.effectAllowed = 'move';
        
        // For touch devices
        if (e.type === 'touchstart') {
          e.preventDefault();
        }
      }
    }

    function handleDragOver(e) {
      if (!state.settings.dragEnabled || !state.dragState.isDragging) return;
      
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const card = getDragTargetCard(e);
      if (card && card !== state.dragState.draggedItem) {
        card.classList.add('dropzone');
      }
    }

    function handleDragEnter(e) {
      if (!state.settings.dragEnabled || !state.dragState.isDragging) return;
      e.preventDefault();
    }

    function handleDragLeave(e) {
      if (!state.settings.dragEnabled || !state.dragState.isDragging) return;
      
      const card = getDragTargetCard(e);
      if (card) {
        card.classList.remove('dropzone');
      }
    }

    function handleDrop(e) {
      if (!state.settings.dragEnabled || !state.dragState.isDragging) return;
      
      e.preventDefault();
      
      const card = getDragTargetCard(e);
      if (card && card !== state.dragState.draggedItem) {
        card.classList.remove('dropzone');
        state.dragState.targetIndex = Array.from(card.parentNode.children).indexOf(card);
        
        // Reorder the links array
        const draggedLink = state.links.find(l => l.id === state.dragState.draggedItem.dataset.id);
        const targetLink = state.links.find(l => l.id === card.dataset.id);
        
        if (draggedLink && targetLink) {
          const draggedIndex = state.links.indexOf(draggedLink);
          const targetIndex = state.links.indexOf(targetLink);
          
          state.links.splice(draggedIndex, 1);
          state.links.splice(targetIndex, 0, draggedLink);
          
          saveSettings();
          renderChannels();
        }
      }
    }

    function handleDragEnd() {
      if (!state.settings.dragEnabled || !state.dragState.isDragging) return;
      
      state.dragState.isDragging = false;
      if (state.dragState.draggedItem) {
        state.dragState.draggedItem.classList.remove('dragging');
      }
      
      document.querySelectorAll('.channel-card').forEach(card => {
        card.classList.remove('dropzone');
      });
    }

    function getDragTargetCard(e) {
      let target = e.target;
      
      // For touch events
      if (e.type.includes('touch')) {
        const touch = e.changedTouches[0];
        target = document.elementFromPoint(touch.clientX, touch.clientY);
      }
      
      while (target && !target.classList.contains('channel-card')) {
        target = target.parentNode;
      }
      
      return target;
    }

    // Edit a link
    function editLink(linkId) {
      const link = state.links.find(l => l.id === linkId);
      if (!link) return;
      
      state.editState.linkId = linkId;
      
      // Fill the form with the link data
      elements.editLinkUrl.value = link.link;
      elements.editLinkTitle.value = link.title;
      elements.editWebName.value = link.webName || '';
      elements.editLinkSport.value = link.deporte;
      elements.editLinkLanguage.value = link.idioma;
      elements.editLinkType.value = link.type;
      elements.editLinkColor.value = link.color || '#2563eb';
      elements.editMostrarIcono.checked = link.mostrarIcono || false;
      elements.editMostrarMulti.checked = link.mostrarMulti || false;
      elements.editFavorito.checked = link.favorito || false;
      elements.editEtiquetas.value = link.etiquetas ? link.etiquetas.join(', ') : '';
      
      // Set rating stars
      document.querySelectorAll('#editRatingStars .star').forEach((star, index) => {
        if (index < (link.puntuacion || 3)) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
      
      elements.editLinkModal.classList.add('modal--active');
    }

    // Save edited link
    function saveEditedLink() {
      const link = state.links.find(l => l.id === state.editState.linkId);
      if (!link) return;
      
      if (!elements.editLinkUrl.value || !elements.editLinkTitle.value) {
        showNotification('URL y t√≠tulo son obligatorios', 'error');
        return;
      }
      
      const selectedStar = document.querySelector('#editRatingStars .star.active');
      const rating = selectedStar ? parseInt(selectedStar.dataset.value) : 3;
      
      const tags = elements.editEtiquetas.value 
        ? elements.editEtiquetas.value.split(',').map(tag => tag.trim()).filter(tag => tag)
        : [];
      
      // Update the link
      link.link = elements.editLinkUrl.value;
      link.title = elements.editLinkTitle.value;
      link.webName = elements.editWebName.value || null;
      link.deporte = elements.editLinkSport.value;
      link.idioma = elements.editLinkLanguage.value;
      link.type = elements.editLinkType.value;
      link.color = elements.editLinkColor.value;
      link.mostrarIcono = elements.editMostrarIcono.checked;
      link.mostrarMulti = elements.editMostrarMulti.checked;
      link.favorito = elements.editFavorito.checked;
      link.puntuacion = rating;
      link.etiquetas = tags;
      
      saveSettings();
      renderChannels();
      closeEditLinkModal();
      showNotification('Enlace actualizado correctamente');
    }

    // Handle clear filters button click (3 times to open settings)
    function handleClearFiltersClick() {
      const now = Date.now();
      
      // Reset counter if more than 1 second has passed since last click
      if (now - state.clearButtonState.lastClickTime > 1000) {
        state.clearButtonState.clickCount = 0;
      }
      
      state.clearButtonState.clickCount++;
      state.clearButtonState.lastClickTime = now;
      
      if (state.clearButtonState.clickCount >= 3) {
        // Open settings modal
        elements.exportLinksData.value = JSON.stringify(state.links, null, 2);
        elements.settingsModal.classList.add('modal--active');
        state.clearButtonState.clickCount = 0;
      } else {
        // Normal clear filters behavior
        state.filters = {
          searchText: '',
          type: 'web',
          sport: null,
          favoritesOnly: false
        };
        
        elements.searchInput.value = '';
        updateTypeFilterButtons();
        updateEmojiFilterButtons();
        elements.filterFavorites.classList.remove('filter-button--active');
        
        renderChannels();
      }
    }

    // Setup all event listeners
    function setupEventListeners() {
      // Drag and drop events
      document.addEventListener('dragstart', handleDragStart);
      document.addEventListener('dragover', handleDragOver);
      document.addEventListener('dragenter', handleDragEnter);
      document.addEventListener('dragleave', handleDragLeave);
      document.addEventListener('drop', handleDrop);
      document.addEventListener('dragend', handleDragEnd);
      
      // Touch events for mobile
      document.addEventListener('touchstart', handleDragStart, { passive: false });
      document.addEventListener('touchmove', (e) => {
        if (state.settings.dragEnabled && state.dragState.isDragging) {
          e.preventDefault();
          const touch = e.touches[0];
          const card = getDragTargetCard(e);
          
          if (card && card !== state.dragState.draggedItem) {
            card.classList.add('dropzone');
          }
        }
      }, { passive: false });
      
      document.addEventListener('touchend', (e) => {
        if (state.settings.dragEnabled && state.dragState.isDragging) {
          e.preventDefault();
          const card = getDragTargetCard(e);
          
          if (card && card !== state.dragState.draggedItem) {
            card.classList.remove('dropzone');
            state.dragState.targetIndex = Array.from(card.parentNode.children).indexOf(card);
            
            const draggedLink = state.links.find(l => l.id === state.dragState.draggedItem.dataset.id);
            const targetLink = state.links.find(l => l.id === card.dataset.id);
            
            if (draggedLink && targetLink) {
              const draggedIndex = state.links.indexOf(draggedLink);
              const targetIndex = state.links.indexOf(targetLink);
              
              state.links.splice(draggedIndex, 1);
              state.links.splice(targetIndex, 0, draggedLink);
              
              saveSettings();
              renderChannels();
            }
          }
          
          handleDragEnd();
        }
      }, { passive: false });
      
      // Link cards
      document.addEventListener('click', function(e) {
        // Handle delete button clicks
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
          e.stopPropagation();
          state.deleteState.linkId = deleteBtn.dataset.id;
          elements.confirmDeleteModal.classList.add('modal--active');
          return;
        }
        
        // Handle edit button clicks
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) {
          e.stopPropagation();
          editLink(editBtn.dataset.id);
          return;
        }
        
        // Handle link card clicks
        const linkCard = e.target.closest('.channel-card');
        if (linkCard) {
          const linkId = linkCard.dataset.id;
          if (state.settings.playerMode === 'inline' || e.ctrlKey || e.metaKey) {
            openLink(linkId);
          } else {
            const link = state.links.find(l => l.id === linkId);
            if (link) {
              window.open(link.link, '_blank');
            }
          }
        }
      });
      
      // Confirm delete modal
      elements.cancelDeleteBtn.addEventListener('click', function() {
        elements.confirmDeleteModal.classList.remove('modal--active');
      });
      
      elements.confirmDeleteBtn.addEventListener('click', function() {
        elements.confirmDeleteModal.classList.remove('modal--active');
        if (state.deleteState.linkId) {
          deleteLink(state.deleteState.linkId);
        }
      });
      
      // Player controls
      elements.prevChannelBtn.addEventListener('click', () => navigateLink('prev'));
      elements.nextChannelBtn.addEventListener('click', () => navigateLink('next'));
      elements.toggleStickyBtn.addEventListener('click', toggleMinimizePlayer);
      elements.favoriteBtn.addEventListener('click', toggleFavorite);
      elements.closePlayerBtn.addEventListener('click', closePlayer);
      
      // Search & filters
      elements.searchInput.addEventListener('input', function() {
        state.filters.searchText = this.value;
        renderChannels();
      });
      
      elements.filterFavorites.addEventListener('click', function() {
        state.filters.favoritesOnly = !state.filters.favoritesOnly;
        this.classList.toggle('filter-button--active', state.filters.favoritesOnly);
        renderChannels();
      });
      
      elements.filterWeb.addEventListener('click', function() {
        state.filters.type = 'web';
        updateTypeFilterButtons();
        renderChannels();
      });
      
      elements.filterAcestream.addEventListener('click', function() {
        state.filters.type = 'acestream';
        updateTypeFilterButtons();
        renderChannels();
      });
      
      elements.filterSources.addEventListener('click', function() {
        state.filters.type = 'source';
        updateTypeFilterButtons();
        renderChannels();
      });
      
      elements.clearFilters.addEventListener('click', handleClearFiltersClick);
      
      // Emoji filters
      elements.emojiFilters.addEventListener('click', function(e) {
        const emojiBtn = e.target.closest('.emoji-filter-btn');
        if (emojiBtn) {
          const sport = emojiBtn.dataset.filter;
          
          if (state.filters.sport === sport) {
            state.filters.sport = null;
          } else {
            state.filters.sport = sport;
          }
          
          updateEmojiFilterButtons();
          renderChannels();
        }
      });
      
      // Toggle drag mode
      elements.toggleDragBtn.addEventListener('click', toggleDragMode);
      
      // Settings modal
      elements.settingsBtn.addEventListener('click', function() {
        elements.exportLinksData.value = JSON.stringify(state.links, null, 2);
        elements.settingsModal.classList.add('modal--active');
      });
      
      elements.closeSettingsModal.addEventListener('click', closeSettingsModal);
      elements.cancelSettingsBtn.addEventListener('click', closeSettingsModal);
      
      elements.saveSettingsBtn.addEventListener('click', function() {
        state.settings.darkMode = elements.darkModeToggle.checked;
        state.settings.playerMode = elements.playerModeSelect.value;
        state.settings.rememberPlayerSize = elements.rememberPlayerSize.checked;
        
        if (state.settings.darkMode) {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
        }
        
        saveSettings();
        closeSettingsModal();
        showNotification('Configuraci√≥n guardada');
      });
      
      // Color picker
      document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.color-option').forEach(opt => {
            opt.classList.remove('color-option--active');
          });
          
          this.classList.add('color-option--active');
          updatePrimaryColor(this.dataset.color);
          saveSettings();
        });
      });
      
      // Import/export tabs
      elements.importExportTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          
          elements.importExportTabs.forEach(t => {
            t.classList.remove('import-export-tab--active');
          });
          this.classList.add('import-export-tab--active');
          
          elements.importExportContents.forEach(content => {
            content.classList.remove('import-export-content--active');
          });
          document.getElementById(`${tabName}Tab`).classList.add('import-export-content--active');
        });
      });
      
      // Copy export data
      elements.copyExportLinksBtn.addEventListener('click', function() {
        elements.exportLinksData.select();
        document.execCommand('copy');
        showNotification('JSON copiado al portapapeles');
      });
      
      // Import data
      elements.importLinksBtn.addEventListener('click', function() {
        try {
          const data = JSON.parse(elements.importLinksData.value);
          state.links = Array.isArray(data) ? data : [];
          
          saveSettings();
          renderChannels();
          closeSettingsModal();
          showNotification('Datos importados correctamente');
        } catch (e) {
          showNotification('Error al importar datos: JSON inv√°lido', 'error');
        }
      });
      
      elements.cancelImportBtn.addEventListener('click', function() {
        elements.importLinksData.value = '';
      });
      
      // Add link modal
      elements.addLinkBtn.addEventListener('click', function() {
        elements.linkUrl.value = '';
        elements.linkTitle.value = '';
        elements.webName.value = '';
        elements.linkSport.value = 'F√∫tbol';
        elements.linkLanguage.value = 'ES';
        elements.linkType.value = 'web';
        elements.linkColor.value = '#2563eb';
        elements.mostrarIcono.checked = false;
        elements.mostrarMulti.checked = false;
        elements.etiquetas.value = '';
        
        document.querySelectorAll('.star').forEach(star => {
          star.classList.remove('active');
        });
        
        elements.addLinkModal.classList.add('modal--active');
      });
      
      elements.closeAddLinkModal.addEventListener('click', closeAddLinkModal);
      elements.cancelAddLinkBtn.addEventListener('click', closeAddLinkModal);
      
      elements.saveLinkBtn.addEventListener('click', function() {
        if (!elements.linkUrl.value || !elements.linkTitle.value) {
          showNotification('URL y t√≠tulo son obligatorios', 'error');
          return;
        }
        
        const selectedStar = document.querySelector('.star.active');
        const rating = selectedStar ? parseInt(selectedStar.dataset.value) : 3;
        
        const tags = elements.etiquetas.value 
          ? elements.etiquetas.value.split(',').map(tag => tag.trim()).filter(tag => tag)
          : [];
        
        const newLink = {
          id: Date.now().toString(),
          link: elements.linkUrl.value,
          title: elements.linkTitle.value,
          webName: elements.webName.value || null,
          deporte: elements.linkSport.value,
          type: elements.linkType.value,
          color: elements.linkColor.value,
          idioma: elements.linkLanguage.value,
          mostrarIcono: elements.mostrarIcono.checked,
          mostrarMulti: elements.mostrarMulti.checked,
          puntuacion: rating,
          etiquetas: tags,
          favorito: false
        };
        
        state.links.push(newLink);
        saveSettings();
        renderChannels();
        closeAddLinkModal();
        showNotification('Enlace a√±adido correctamente');
      });
      
      // Rating stars
      elements.ratingStars.addEventListener('click', function(e) {
        const star = e.target.closest('.star');
        if (star) {
          const value = parseInt(star.dataset.value);
          
          document.querySelectorAll('.star').forEach((s, index) => {
            if (index < value) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        }
      });
      
      // Edit link modal
      elements.closeEditLinkModal.addEventListener('click', closeEditLinkModal);
      elements.cancelEditLinkBtn.addEventListener('click', closeEditLinkModal);
      
      elements.saveEditLinkBtn.addEventListener('click', saveEditedLink);
      
      elements.editRatingStars.addEventListener('click', function(e) {
        const star = e.target.closest('.star');
        if (star) {
          const value = parseInt(star.dataset.value);
          
          document.querySelectorAll('#editRatingStars .star').forEach((s, index) => {
            if (index < value) {
              s.classList.add('active');
            } else {
              s.classList.remove('active');
            }
          });
        }
      });
      
      // Toggle theme button
      elements.toggleThemeBtn.addEventListener('click', function() {
        state.settings.darkMode = !state.settings.darkMode;
        
        if (state.settings.darkMode) {
          document.body.classList.add('dark-mode');
        } else {
          document.body.classList.remove('dark-mode');
        }
        
        saveSettings();
      });
      
      // Clear all button
      elements.clearAllBtn.addEventListener('click', function() {
        elements.confirmClearModal.classList.add('modal--active');
      });
      
      elements.cancelClearBtn.addEventListener('click', function() {
        elements.confirmClearModal.classList.remove('modal--active');
      });
      
      elements.confirmClearBtn.addEventListener('click', function() {
        elements.confirmClearModal.classList.remove('modal--active');
        clearAllData();
      });
      
      // Scroll events
      window.addEventListener('scroll', checkScrollPosition);
      
      // Scroll to top
      elements.scrollToTop.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    // Update type filter buttons active state
    function updateTypeFilterButtons() {
      elements.filterWeb.classList.toggle('filter-button--active', state.filters.type === 'web');
      elements.filterAcestream.classList.toggle('filter-button--active', state.filters.type === 'acestream');
      elements.filterSources.classList.toggle('filter-button--active', state.filters.type === 'source');
    }

    // Update emoji filter buttons active state
    function updateEmojiFilterButtons() {
      document.querySelectorAll('.emoji-filter-btn').forEach(btn => {
        btn.classList.toggle('emoji-filter-btn--active', btn.dataset.filter === state.filters.sport);
      });
    }

    // Close settings modal
    function closeSettingsModal() {
      elements.settingsModal.classList.remove('modal--active');
    }

    // Close add link modal
    function closeAddLinkModal() {
      elements.addLinkModal.classList.remove('modal--active');
    }

    // Close edit link modal
    function closeEditLinkModal() {
      elements.editLinkModal.classList.remove('modal--active');
    }

    // Helper function to shade colors
    function shadeColor(color, percent) {
      let R = parseInt(color.substring(1,3), 16);
      let G = parseInt(color.substring(3,5), 16);
      let B = parseInt(color.substring(5,7), 16);

      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);

      R = (R<255)?R:255;  
      G = (G<255)?G:255;  
      B = (B<255)?B:255;  

      const RR = ((R.toString(16).length===1)?"0"+R.toString(16):R.toString(16));
      const GG = ((G.toString(16).length===1)?"0"+G.toString(16):G.toString(16));
      const BB = ((B.toString(16).length===1)?"0"+B.toString(16):B.toString(16));

      return "#"+RR+GG+BB;
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>